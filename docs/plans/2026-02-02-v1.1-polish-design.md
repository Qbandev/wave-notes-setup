# Wave Notes Setup v1.1 - Technical Specification

## Overview

Polish release focusing on widget configuration improvements and installation robustness. No new features.

## Goals

- Align widget configurations with Wave Terminal best practices
- Improve installation reliability with validation and rollback
- Add safety checks without breaking existing workflows

## Non-Goals

- New widgets (search, today's notes)
- Cross-platform support (Linux/Windows)
- Upstream contribution to Wave Terminal

## Widget Configuration Changes

### wave-new-note Widget

```json
{
  "wave-new-note": {
    "icon": "file-circle-plus",
    "label": "new note",
    "description": "Create a new timestamped note",
    "display:order": 10,
    "blockdef": {
      "meta": {
        "view": "term",
        "controller": "cmd",
        "cmd": "wave-scratch.sh",
        "cmd:cwd": "$HOME/Documents/WaveNotes",
        "cmd:runonstart": true,
        "cmd:clearonstart": true,
        "cmd:closeonexit": true,
        "cmd:closeonexitdelay": 0
      }
    }
  }
}
```

### wave-all-notes Widget

```json
{
  "wave-all-notes": {
    "icon": "folder-open",
    "label": "all notes",
    "description": "Browse all notes",
    "display:order": 11,
    "blockdef": {
      "meta": {
        "view": "term",
        "controller": "cmd",
        "cmd": "ls -lt *.md 2>/dev/null | head -20 || echo 'No notes yet'",
        "cmd:cwd": "$HOME/Documents/WaveNotes",
        "cmd:runonstart": true,
        "cmd:clearonstart": true
      }
    }
  }
}
```

### Meta Fields Added

| Field | Purpose |
|-------|---------|
| `description` | Tooltip on hover |
| `display:order` | Sidebar position (10, 11 keeps adjacent) |
| `cmd:cwd` | Working directory for relative paths |
| `cmd:runonstart` | Execute immediately on open |
| `cmd:clearonstart` | Clear previous output |
| `cmd:closeonexit` | Auto-close after completion (new-note only) |
| `cmd:closeonexitdelay` | 1s delay before closing |

## Installation Script Changes

### Wave Terminal Detection

```bash
check_wave_installed() {
    if [[ -d ~/.config/waveterm ]]; then
        return 0
    elif command -v wsh &>/dev/null; then
        return 0
    else
        error "Wave Terminal is not installed"
        error "Install from: https://www.waveterm.dev/download"
        return 1
    fi
}
```

Blocks installation if Wave not found.

### JSON Validation

```bash
validate_widgets() {
    local widgets_file="$1"
    if command -v jq &>/dev/null; then
        jq empty "$widgets_file" 2>/dev/null
        return $?
    elif command -v python3 &>/dev/null; then
        python3 -c "import json; json.load(open('$widgets_file'))"
        return $?
    fi
    return 0
}
```

### Backup with Permissions

```bash
backup_widgets() {
    local widgets_file="$1"
    if [[ -f "$widgets_file" ]]; then
        local backup="$widgets_file.backup.$(date +%s)"
        cp "$widgets_file" "$backup"
        chmod 600 "$backup"
        info "Backed up to $backup"
        echo "$backup"
    fi
}
```

### Rollback on Failure

```bash
if ! validate_widgets "$WIDGETS_FILE"; then
    error "Generated widgets.json is invalid"
    if [[ -n "$BACKUP_FILE" && -f "$BACKUP_FILE" ]]; then
        cp "$BACKUP_FILE" "$WIDGETS_FILE"
        info "Restored backup"
    fi
    exit 1
fi
```

## Installation Flow

1. Pre-flight: Check Wave installed (exit if not)
2. Backup: Save widgets.json with 600 permissions
3. Install: Create notes dir, install script, merge widgets
4. Validate: Check JSON syntax, rollback if invalid
5. Success: Show summary, remind to restart Wave

## New Tests

| Test | Description |
|------|-------------|
| `test_wave_detection_with_config_dir` | Pass when ~/.config/waveterm exists |
| `test_wave_detection_with_wsh` | Pass when wsh available |
| `test_wave_detection_missing` | Fail when Wave not found |
| `test_widgets_json_validation_valid` | Pass with valid JSON |
| `test_widgets_json_validation_invalid` | Fail with malformed JSON |
| `test_backup_created` | Verify backup exists |
| `test_backup_permissions` | Verify 600 permissions |
| `test_rollback_on_invalid` | Verify restore on failure |

## Files Changed

| File | Changes |
|------|---------|
| `install.sh` | Add detection, validation, backup, rollback |
| `test/install.bats` | Add 8 new tests |

## Success Criteria

- [ ] All 54 tests pass (46 + 8 new)
- [ ] shellcheck reports no issues
- [ ] Fresh install works with Wave installed
- [ ] Fresh install fails without Wave
- [ ] Invalid JSON triggers rollback
- [ ] Backup has 600 permissions
