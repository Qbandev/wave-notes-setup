# AI Agent Instructions for wave-notes-setup

## Project Overview

**wave-notes-setup** is a CLI tool that configures Wave Terminal with a Warp-like notes system. It installs custom sidebar widgets for creating and browsing markdown notes.

## Architecture

```
wave-notes-setup/
├── install.sh              # Main installer
├── uninstall.sh            # Standalone uninstaller
├── README.md               # User documentation
├── LICENSE                 # MIT License
├── .wave-notes.conf.example # Config template
├── .agents.md              # AI agent instructions
├── Formula/
│   └── wave-notes-setup.rb # Homebrew formula
├── test/
│   ├── test_helper.bash    # Test utilities and mocks
│   ├── install.bats        # Unit tests for install.sh
│   ├── uninstall.bats      # Unit tests for uninstall.sh
│   └── run_tests.sh        # Local test runner
└── .github/
    └── workflows/
        ├── test.yml             # CI workflow (shellcheck + bats)
        └── release-please.yml   # Automated releases with release-please
```

## Key Components

### 1. install.sh
- **Purpose**: Configure Wave Terminal with notes widgets
- **Configuration Precedence**: defaults → ~/.wave-notes.conf → env vars
- **Key Functions**:
  - `detect_waveterm_config()` - Finds Wave Terminal config path (supports v0.9+ and older)
  - `check_wave_installed()` - Blocks installation if Wave Terminal not found
  - `validate_widgets()` - Validates JSON with jq or python3 fallback
  - `install_scratchpad_script()` - Generates ~/bin/wave-scratch.sh
  - `install_widgets()` - Merges widgets into widgets.json with validation and rollback
  - `get_max_display_order()` - Preserves existing widget ordering

### 2. wave-scratch.sh (Generated)
- **Purpose**: Create timestamped note and open in Wave editor
- **Key Feature**: `find_wsh()` function searches multiple paths for wsh binary
- **Output**: Creates `note-YYYY-MM-DD_HHMMSS.md` in notes directory

### 3. Widget Configuration
One widget is installed to `~/.config/waveterm/widgets.json`:

```json
{
  "custom:notes-new": {
    "view": "term",
    "controller": "cmd",
    "cmd": "~/bin/wave-scratch.sh",
    "cmd:closeonexit": true,
    "cmd:closeonexitdelay": 0
  }
}
```

## Critical Constraints

### DO NOT
- Hardcode user-specific paths (use $HOME, $NOTES_DIR, $BIN_DIR)
- Add `color` property to widgets (must follow Wave Terminal theme)
- Use `wsh` directly in widget cmd (not in PATH for non-interactive shells)
- Remove the `find_wsh()` function from wave-scratch.sh

### MUST
- Use `set -euo pipefail` in all bash scripts
- Support both `~/.config/waveterm` (v0.9+) and `~/.waveterm` paths
- Use atomic writes (temp file + mv) for JSON modifications
- Verify script origin before deletion (check "Generated by" header)
- Include `cmd:closeonexit: true` and `cmd:closeonexitdelay: 0` for term widgets

## Wave Terminal Widget Best Practices

Reference: https://docs.waveterm.dev/customwidgets

### Widget Meta Options
| Option | Description |
|--------|-------------|
| `cmd:closeonexit` | Auto-close on exit code 0 |
| `cmd:closeonexitdelay` | Delay before close (ms), set to 0 for instant |
| `cmd:shell` | Enable shell syntax (pipes, redirects) |
| `cmd:clearonstart` | Clear block before running |

### View Types
- `term` - Terminal with command execution
- `preview` - File/directory browser (preferred for browsing)
- `web` - Web page display
- `sysinfo` - System monitoring

## Testing Checklist

Before committing changes:
1. [ ] Run `shellcheck install.sh uninstall.sh`
2. [ ] Test fresh install on clean Wave Terminal config
3. [ ] Test install with existing widgets.json
4. [ ] Test uninstall preserves other widgets
5. [ ] Test with custom WAVE_NOTES_DIR and WAVE_BIN_DIR
6. [ ] Verify no hardcoded paths in generated files

## Common Issues

### "wsh command not found"
The `find_wsh()` function in wave-scratch.sh searches:
1. `command -v wsh` (PATH)
2. `$HOME/Library/Application Support/waveterm/bin/wsh`
3. `/usr/local/bin/wsh`
4. `/opt/homebrew/bin/wsh`

### "No View Component" error
Use `view: "preview"` with `file:` for directory browsing, not `view: "term"` with `wsh view`.

### Terminal block flashes briefly
This is a Wave Terminal limitation. Minimize with:
- `cmd:closeonexit: true`
- `cmd:closeonexitdelay: 0`

## Development Workflow

```bash
# Run automated tests (54 tests)
./test/run_tests.sh

# Or run bats directly
bats test/*.bats

# Check for shellcheck issues
shellcheck install.sh uninstall.sh

# Test installation manually
./install.sh -v

# Test uninstallation manually
./install.sh --uninstall

# Validate JSON output
cat ~/.config/waveterm/widgets.json | jq .
```

## Test Coverage

The test suite includes **54 tests** covering:

### Unit Tests (install.bats)
- `detect_waveterm_config()` - Path detection for both v0.9+ and older
- `load_config()` - Config file parsing, env var precedence, tilde expansion
- `get_max_display_order()` - Widget ordering calculation
- `get_existing_order()` - Preserve existing widget positions
- `create_directories()` - Directory creation
- `install_scratchpad_script()` - Script generation and content verification
- `install_widgets()` - JSON merging, backup creation, validation, rollback
- `check_wave_installed()` - Wave Terminal detection (config dirs, wsh command)
- `validate_widgets()` - JSON validation with jq/python3 fallback

### Unit Tests (uninstall.bats)
- `remove_widgets()` - Selective removal of notes-* widgets
- `remove_script()` - Origin verification before deletion

### Integration Tests
- Full install creates all expected files
- Install is idempotent (safe to run multiple times)
- Uninstall preserves other widgets
- Uninstall preserves user notes by default

## Function Reference

### install.sh Functions

| Function | Purpose | Parameters |
|----------|---------|------------|
| `detect_waveterm_config()` | Find Wave Terminal config directory | None |
| `load_config()` | Load configuration (defaults → file → env) | None |
| `check_macos()` | Verify running on macOS | None |
| `check_wave_installed()` | Block install if Wave Terminal not found | None |
| `validate_widgets()` | Validate JSON with jq or python3 fallback | `$1`: widgets.json path |
| `create_directories()` | Create notes and bin directories | None |
| `install_scratchpad_script()` | Generate wave-scratch.sh | None |
| `get_max_display_order()` | Find highest widget order | `$1`: widgets.json path |
| `get_existing_order()` | Get widget's current order | `$1`: path, `$2`: key, `$3`: default |
| `install_widgets()` | Merge widgets with validation and rollback | None |
| `run_uninstall()` | Execute uninstall procedure | None |
| `parse_args()` | Parse CLI arguments | `$@`: arguments |

### uninstall.sh Functions

| Function | Purpose | Parameters |
|----------|---------|------------|
| `detect_waveterm_config()` | Find Wave Terminal config directory | None |
| `load_config()` | Load configuration | None |
| `remove_widgets()` | Remove notes-* widgets from JSON | None |
| `remove_script()` | Remove wave-scratch.sh (with verification) | None |
| `prompt_notes_deletion()` | Ask user about deleting notes | None |
| `prompt_config_deletion()` | Ask user about deleting config | None |

### Global Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `NOTES_DIR` | `$HOME/Documents/WaveNotes` | Notes storage directory |
| `BIN_DIR` | `$HOME/bin` | Script installation directory |
| `WAVETERM_CONFIG` | Auto-detected | Wave Terminal config path |
| `CONFIG_FILE` | `$HOME/.wave-notes.conf` | Optional config file path |
| `FORCE` | `false` | Skip confirmation prompts (reserved) |
| `VERBOSE` | `false` | Enable debug output |
| `UNINSTALL` | `false` | Run uninstall mode |

## Error Handling

The scripts use `set -euo pipefail`:
- `-e`: Exit on any command failure
- `-u`: Error on undefined variables
- `-o pipefail`: Fail pipe if any command fails

### Exit Codes

| Code | Meaning |
|------|---------|
| 0 | Success |
| 1 | General error (missing dependency, invalid option) |

### Error Recovery

- **Backup before modify**: widgets.json is backed up with chmod 600 before changes
- **Atomic writes**: Use temp file + mv for JSON writes
- **JSON validation**: Validate widgets.json after generation (jq or python3 fallback)
- **Rollback on failure**: Restore backup if validation fails; remove invalid file on fresh install
- **Origin verification**: Only delete scripts with "Generated by" header
- **User confirmation**: Destructive operations require explicit consent

## Future Enhancements (v2.0)

- [ ] Linux support (different config paths)
- [ ] Note templates
- [ ] Tag-based organization
- [ ] Full-text search widget
- [ ] Note archiving
