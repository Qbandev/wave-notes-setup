name: Tests

permissions:
  contents: read

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck on main scripts
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          ignore_paths: 'test'

      - name: Run ShellCheck on test helper
        run: shellcheck test/test_helper.bash

  bats:
    name: Bats Tests
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install bats
        run: brew install bats-core

      - name: Run tests
        run: bats test/*.bats

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check for common issues
        run: |
          # Check for hardcoded user paths
          if grep -r '/Users/[a-zA-Z]' --include='*.sh' --exclude-dir=test .; then
            echo "ERROR: Found hardcoded user paths"
            exit 1
          fi

          # Check for set -euo pipefail
          for f in install.sh uninstall.sh; do
            if ! grep -q 'set -euo pipefail' "$f"; then
              echo "ERROR: $f missing 'set -euo pipefail'"
              exit 1
            fi
          done

          echo "All lint checks passed!"

      - name: Check VERSION consistency
        run: |
          FILE_VERSION=$(cat VERSION)
          SCRIPT_VERSION=$(grep 'x-release-please-version' install.sh | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          UNINSTALL_VERSION=$(grep 'x-release-please-version' uninstall.sh | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          if [ "$FILE_VERSION" != "$SCRIPT_VERSION" ]; then
            echo "ERROR: VERSION ($FILE_VERSION) != install.sh ($SCRIPT_VERSION)"
            exit 1
          fi
          if [ "$FILE_VERSION" != "$UNINSTALL_VERSION" ]; then
            echo "ERROR: VERSION ($FILE_VERSION) != uninstall.sh ($UNINSTALL_VERSION)"
            exit 1
          fi
          echo "VERSION consistency check passed: $FILE_VERSION"
