name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  # First, run all tests to ensure release is stable
  test:
    name: Verify Release
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install bats
        run: brew install bats-core

      - name: Run ShellCheck
        run: |
          brew install shellcheck
          shellcheck install.sh uninstall.sh test/test_helper.bash

      - name: Run tests
        run: bats test/*.bats

  # Create GitHub release with changelog and assets
  release:
    name: Create Release
    needs: test
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Generate changelog
        id: changelog
        run: |
          # Get commits since last tag
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -n "$PREV_TAG" ]; then
            echo "Generating changelog from $PREV_TAG to ${{ steps.version.outputs.version }}"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
          else
            echo "First release, including all commits"
            CHANGELOG=$(git log --pretty=format:"- %s (%h)")
          fi

          # Write to file for multiline output
          echo "$CHANGELOG" > changelog.txt

          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Calculate SHA256
        id: sha256
        run: |
          # Download the tarball that GitHub creates for this tag
          TARBALL_URL="https://github.com/${{ github.repository }}/archive/${{ steps.version.outputs.version }}.tar.gz"
          curl -sL "$TARBALL_URL" -o release.tar.gz
          SHA256=$(shasum -a 256 release.tar.gz | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Create Release
        uses: actions/github-script@v7
        env:
          VERSION: ${{ steps.version.outputs.version }}
          VERSION_NUMBER: ${{ steps.version.outputs.version_number }}
          CHANGELOG: ${{ steps.changelog.outputs.changelog }}
          SHA256: ${{ steps.sha256.outputs.sha256 }}
        with:
          script: |
            const { VERSION, VERSION_NUMBER, CHANGELOG, SHA256 } = process.env;

            const releaseBody = `## What's Changed

            ${CHANGELOG}

            ## Installation

            ### Homebrew (Recommended)
            \`\`\`bash
            brew tap qbandev/wave-notes-setup
            brew install wave-notes-setup
            wave-notes-setup
            \`\`\`

            ### curl
            \`\`\`bash
            curl -fsSL https://raw.githubusercontent.com/qbandev/wave-notes-setup/${VERSION}/install.sh | bash
            \`\`\`

            ### Manual
            \`\`\`bash
            git clone https://github.com/qbandev/wave-notes-setup.git
            cd wave-notes-setup
            git checkout ${VERSION}
            ./install.sh
            \`\`\`

            ## Homebrew Formula Update

            Update \`Formula/wave-notes-setup.rb\`:
            \`\`\`ruby
            url "https://github.com/qbandev/wave-notes-setup/archive/${VERSION}.tar.gz"
            sha256 "${SHA256}"
            \`\`\`

            ---
            **Full Changelog**: https://github.com/${context.repo.owner}/${context.repo.repo}/compare/...${VERSION}
            `;

            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: VERSION,
              name: `wave-notes-setup ${VERSION}`,
              body: releaseBody,
              draft: false,
              prerelease: VERSION.includes('-')
            });

            console.log(`Release ${VERSION} created successfully`);
            console.log(`SHA256 for Homebrew: ${SHA256}`);

  # Notify about formula update needed
  notify-homebrew:
    name: Homebrew Update Reminder
    needs: release
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Create issue for Homebrew update
        uses: actions/github-script@v7
        with:
          script: |
            const version = '${{ github.ref_name }}';

            // Check if issue already exists
            const { data: issues } = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'homebrew,release'
            });

            const existingIssue = issues.find(i => i.title.includes(version));
            if (existingIssue) {
              console.log('Issue already exists for this version');
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Update Homebrew formula for ${version}`,
              body: `A new release ${version} has been published.

            ## Action Required

            Update the Homebrew formula with the new SHA256 from the release notes.

            1. Go to [Releases](https://github.com/${context.repo.owner}/${context.repo.repo}/releases/tag/${version})
            2. Copy the SHA256 value
            3. Update \`Formula/wave-notes-setup.rb\`:
               - Update the \`url\` to point to ${version}
               - Update the \`sha256\` value
            4. Commit and push the changes
            5. Close this issue

            This issue was automatically created by the release workflow.`,
              labels: ['homebrew', 'release']
            });
