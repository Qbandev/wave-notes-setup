name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  copilot-review:
    name: Request Copilot Review
    runs-on: ubuntu-latest
    # Only run on PRs from the same repo (not forks)
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - name: Request GitHub Copilot Review
        uses: actions/github-script@v7
        with:
          script: |
            try {
              await github.rest.pulls.requestReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                reviewers: ['copilot-pull-request-reviewer[bot]']
              });
              console.log('Successfully requested Copilot review');
            } catch (error) {
              // Copilot might not be enabled or already requested
              if (error.status === 422) {
                console.log('Copilot review already requested or not available');
              } else {
                console.log(`Note: Could not request Copilot review: ${error.message}`);
              }
              // Don't fail the workflow - this is optional
            }

      - name: Add review checklist comment
        uses: actions/github-script@v7
        with:
          script: |
            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number
            });

            const botComment = comments.find(c =>
              c.user.type === 'Bot' &&
              c.body.includes('## Review Checklist')
            );

            if (botComment) {
              console.log('Review checklist already posted');
              return;
            }

            const checklist = `## Review Checklist

            Please ensure the following before merging:

            ### Code Quality
            - [ ] \`shellcheck install.sh uninstall.sh\` passes
            - [ ] \`bats test/*.bats\` - all tests pass
            - [ ] No hardcoded user paths (use \`$HOME\`, \`$NOTES_DIR\`, etc.)

            ### Testing
            - [ ] Tested fresh install on clean Wave Terminal config
            - [ ] Tested install with existing widgets.json
            - [ ] Tested uninstall preserves other widgets
            - [ ] Verified generated files have no hardcoded paths

            ### Documentation
            - [ ] README updated if needed
            - [ ] .agents.md updated if functions changed

            ---
            *GitHub Copilot has been requested to review this PR.*
            `;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: checklist
            });
