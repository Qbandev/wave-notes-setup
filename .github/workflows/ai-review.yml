name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest
    # Skip if PR is from a fork (no access to secrets)
    if: github.event.pull_request.head.repo.full_name == github.repository

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed
        run: |
          files=$(git diff --name-only origin/${{ github.base_ref }}...HEAD)
          echo "files<<EOF" >> $GITHUB_OUTPUT
          echo "$files" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Get diff
        id: diff
        run: |
          # Get diff, limit to 10000 chars to stay within token limits
          diff=$(git diff origin/${{ github.base_ref }}...HEAD | head -c 10000)
          echo "diff<<EOF" >> $GITHUB_OUTPUT
          echo "$diff" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: AI Review
        uses: actions/github-script@v7
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          CHANGED_FILES: ${{ steps.changed.outputs.files }}
          DIFF_CONTENT: ${{ steps.diff.outputs.diff }}
        with:
          script: |
            const https = require('https');

            // Skip if no API key configured
            if (!process.env.ANTHROPIC_API_KEY) {
              console.log('ANTHROPIC_API_KEY not configured, skipping AI review');
              return;
            }

            const prompt = `You are reviewing a pull request for wave-notes-setup, a CLI tool that configures Wave Terminal with a Warp-like notes system.

            Project context:
            - Shell scripts (bash) using set -euo pipefail
            - Uses jq with Python fallback for JSON processing
            - Installs widgets to ~/.config/waveterm/widgets.json
            - Must support both old (~/.waveterm) and new (~/.config/waveterm) paths

            Changed files:
            ${process.env.CHANGED_FILES}

            Diff:
            ${process.env.DIFF_CONTENT}

            Provide a concise code review with:
            1. **Summary**: What this PR does (1-2 sentences)
            2. **Strengths**: What's good about this change
            3. **Issues**: Any bugs, security concerns, or problems (be specific with line references)
            4. **Suggestions**: Improvements to consider

            Keep the review focused and actionable. Use GitHub markdown formatting.`;

            const requestBody = JSON.stringify({
              model: 'claude-sonnet-4-20250514',
              max_tokens: 2048,
              messages: [{ role: 'user', content: prompt }]
            });

            const response = await new Promise((resolve, reject) => {
              const req = https.request({
                hostname: 'api.anthropic.com',
                path: '/v1/messages',
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'x-api-key': process.env.ANTHROPIC_API_KEY,
                  'anthropic-version': '2023-06-01'
                }
              }, (res) => {
                let data = '';
                res.on('data', chunk => data += chunk);
                res.on('end', () => {
                  if (res.statusCode === 200) {
                    resolve(JSON.parse(data));
                  } else {
                    reject(new Error(`API error: ${res.statusCode} - ${data}`));
                  }
                });
              });
              req.on('error', reject);
              req.write(requestBody);
              req.end();
            });

            const reviewBody = `## AI Code Review

            ${response.content[0].text}

            ---
            *Automated review by Claude. Please verify suggestions before applying.*`;

            await github.rest.pulls.createReview({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number,
              body: reviewBody,
              event: 'COMMENT'
            });

            console.log('AI review posted successfully');
